# Use an official Python runtime as a parent image
FROM python:3.12.2-alpine

WORKDIR /app

# Install build deps
RUN apk add --no-cache gcc python3-dev musl-dev linux-headers

# Install uv (from official image)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Copy metadata first, so dependency layer is cacheable
COPY pyproject.toml uv.lock ./

# Install all deps (including dev, if you want)
RUN uv sync --frozen

# Copy source code
COPY . /app

# Create a non-root user and switch to it
RUN adduser -D myuser
USER myuser

EXPOSE 5000

ENV FLASK_APP=app.py \
    LOG_DIRECTORY=/app/logs/

# Run Flask dev server via uv
CMD ["uv", "run", "flask", "run", "--host=0.0.0.0"]

